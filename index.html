<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <style>
        /* 画面全体のレイアウト */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* 画面外にはみ出た文字を隠す */
        }

        body { 
            background-color: rgba(0, 0, 0, 0); 
            display: flex;
            flex-direction: column;
            justify-content: flex-end; /* 常に下側に中身を寄せる */
            padding: 20px;
            color: white; 
            font-family: sans-serif;
            font-size: 24px; 
            text-shadow: 2px 2px 2px #000; 
        }

        /* チャットが溜まる箱 */
        #chat-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            /* スムーズに競り上がるアニメーション（任意） */
            transition: all 0.3s ease;
        }

        .message { 
            line-height: 1.4;
            word-break: break-all;
            overflow-wrap: anywhere;
            /* 新しいメッセージがスッと出てくるアニメーション */
            animation: slideIn 0.2s ease-out forwards;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-name { font-weight: bold; margin-right: 8px; white-space: nowrap; }
        .content { display: inline; }
        .emote { vertical-align: middle; margin: -2px 2px 0; width: 1.1em; }
    </style>
</head>
<body>
    <div id="chat-container"></div>

    <script>
        const CHANNEL_NAME = 'nao075';

        function connectTwitch() {
            const socket = new WebSocket('wss://irc-ws.chat.twitch.tv:443');

            socket.onopen = () => {
                socket.send('CAP REQ :twitch.tv/tags twitch.tv/commands');
                socket.send('PASS oauth:xdanyway');
                socket.send('NICK justinfan123');
                socket.send(`JOIN #${CHANNEL_NAME}`);
            };

            socket.onmessage = (event) => {
                const data = event.data;
                if (data.includes('PRIVMSG')) {
                    const tagPart = data.split(' :')[0];
                    const color = tagPart.match(/color=([^;]+)/)?.[1] || "#ffb86c";
                    const displayName = tagPart.match(/display-name=([^;]+)/)?.[1] || "匿名";
                    const emotesTag = tagPart.match(/emotes=([^;]+)/)?.[1] || "";
                    let message = data.split(`PRIVMSG #${CHANNEL_NAME} :`)[1].trim();

                    if (emotesTag) {
                        message = parseEmotes(message, emotesTag);
                    }

                    const container = document.getElementById('chat-container');
                    const div = document.createElement('div');
                    div.className = 'message';
                    div.innerHTML = `<span class="user-name" style="color: ${color}">${displayName}:</span><span class="content">${message}</span>`;
                    
                    container.appendChild(div);

                    // 画面内に残す最大件数（画面の高さに合わせて調整してください）
                    // 30件くらいにしておくと、古いものが自然に画面の上に押し出されます
                    if (container.childNodes.length > 30) {
                        container.removeChild(container.firstChild);
                    }
                }
                if (data.startsWith('PING')) socket.send('PONG :tmi.twitch.tv');
            };

            function parseEmotes(text, emotes) {
                let emoteList = [];
                emotes.split('/').forEach(item => {
                    const [id, ranges] = item.split(':');
                    ranges.split(',').forEach(range => {
                        const [start, end] = range.split('-').map(Number);
                        emoteList.push({ id, start, end });
                    });
                });
                emoteList.sort((a, b) => b.start - a.start);
                let html = text;
                emoteList.forEach(emote => {
                    const url = `https://static-cdn.jtvnw.net/emoticons/v2/${emote.id}/default/dark/1.0`;
                    const imgTag = `<img class="emote" src="${url}">`;
                    html = html.substring(0, emote.start) + imgTag + html.substring(emote.end + 1);
                });
                return html;
            }

            socket.onclose = () => setTimeout(connectTwitch, 5000);
        }
        connectTwitch();
    </script>
</body>
</html>