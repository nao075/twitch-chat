<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <style>
        body { 
            background-color: rgba(0, 0, 0, 0); 
            margin: 0; 
            padding: 20px; 
            color: white; 
            font-family: sans-serif;
            font-size: 24px; 
            text-shadow: 2px 2px 2px #000; 
            overflow: hidden; 
        }
        .message { 
            margin-bottom: 15px; 
            line-height: 1.6;
            word-wrap: break-word; 
            overflow-wrap: break-word; 
            /* フレックスボックスを使って、名前とメッセージの並びを制御します */
            display: flex;
            flex-wrap: wrap; 
            align-items: baseline;
        }
        .user-name { 
            font-weight: bold; 
            margin-right: 8px;
            /* 名前が途中で改行されないように固定する */
            white-space: nowrap; 
            flex-shrink: 0;
        }
        .content {
            /* メッセージ部分は自由に改行を許可する */
            white-space: normal;
            flex-grow: 1;
        }
        .emote { 
            vertical-align: middle; 
            margin: -2px 2px 0; 
            width: 1.2em; /* 文字の大きさに合わせる */
        }
    </style>
</head>
<body>
    <div id="chat-container"></div>

    <script>
        const CHANNEL_NAME = 'nao075';

        function connectTwitch() {
            const socket = new WebSocket('wss://irc-ws.chat.twitch.tv:443');

            socket.onopen = () => {
                socket.send('CAP REQ :twitch.tv/tags twitch.tv/commands');
                socket.send('PASS oauth:xdanyway');
                socket.send('NICK justinfan123');
                socket.send(`JOIN #${CHANNEL_NAME}`);
            };

            socket.onmessage = (event) => {
                const data = event.data;
                if (data.includes('PRIVMSG')) {
                    const tagPart = data.split(' :')[0];
                    const color = tagPart.match(/color=([^;]+)/)?.[1] || "#ffb86c";
                    const displayName = tagPart.match(/display-name=([^;]+)/)?.[1] || "匿名";
                    const emotesTag = tagPart.match(/emotes=([^;]+)/)?.[1] || "";
                    let message = data.split(`PRIVMSG #${CHANNEL_NAME} :`)[1].trim();

                    if (emotesTag) {
                        message = parseEmotes(message, emotesTag);
                    }

                    const container = document.getElementById('chat-container');
                    const div = document.createElement('div');
                    div.className = 'message';
                    // 名前とメッセージを別々のタグで囲んで、CSSで制御しやすくします
                    div.innerHTML = `<span class="user-name" style="color: ${color}">${displayName}:</span><span class="content">${message}</span>`;
                    container.appendChild(div);

                    if (container.childNodes.length > 25) {
                        container.removeChild(container.firstChild);
                    }
                    window.scrollTo(0, document.body.scrollHeight);
                }
                if (data.startsWith('PING')) socket.send('PONG :tmi.twitch.tv');
            };

            function parseEmotes(text, emotes) {
                let emoteList = [];
                emotes.split('/').forEach(item => {
                    const [id, ranges] = item.split(':');
                    ranges.split(',').forEach(range => {
                        const [start, end] = range.split('-').map(Number);
                        emoteList.push({ id, start, end });
                    });
                });
                emoteList.sort((a, b) => b.start - a.start);
                let html = text;
                emoteList.forEach(emote => {
                    const url = `https://static-cdn.jtvnw.net/emoticons/v2/${emote.id}/default/dark/1.0`;
                    const imgTag = `<img class="emote" src="${url}">`;
                    html = html.substring(0, emote.start) + imgTag + html.substring(emote.end + 1);
                });
                return html;
            }
            socket.onclose = () => setTimeout(connectTwitch, 5000);
        }
        connectTwitch();
    </script>
</body>
</html>