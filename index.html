<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <style>
        body { background-color: rgba(0, 0, 0, 0); margin: 0; padding: 20px; color: white; font-family: sans-serif; font-size: 24px; text-shadow: 2px 2px 2px #000; }
        .message { margin-bottom: 10px; }
        .user-name { font-weight: bold; color: #ffb86c; }
    </style>
</head>
<body>
    <div id="chat-container"></div>

    <script>
        const CHANNEL_NAME = 'nao075';

        function connectTwitch() {
            // WebSocketという通信方式を使ってTwitchのチャットサーバーに直接つなぎます
            const socket = new WebSocket('wss://irc-ws.chat.twitch.tv:443');

            socket.onopen = () => {
                socket.send('CAP REQ :twitch.tv/tags twitch.tv/commands');
                socket.send('PASS oauth:xdanyway'); // 読み取り専用なのでこのままでOK
                socket.send('NICK justinfan123');
                socket.send(`JOIN #${CHANNEL_NAME}`);
                console.log('Twitchサーバーに接続しました！');
            };

            socket.onmessage = (event) => {
                const data = event.data;
                
                // チャットメッセージ（PRIVMSG）だけを抽出する
                if (data.includes('PRIVMSG')) {
                    const displayName = data.match(/display-name=([^;]+)/)?.[1] || "匿名";
                    const message = data.split(`PRIVMSG #${CHANNEL_NAME} :`)[1];

                    if (message) {
                        const container = document.getElementById('chat-container');
                        const div = document.createElement('div');
                        div.className = 'message';
                        div.innerHTML = `<span class="user-name">${displayName}:</span> ${message.trim()}`;
                        container.appendChild(div);

                        // 20件を超えたら古いものを消す
                        if (container.childNodes.length > 20) {
                            container.removeChild(container.firstChild);
                        }
                    }
                }
                
                // 接続を維持するための応答
                if (data.startsWith('PING')) {
                    socket.send('PONG :tmi.twitch.tv');
                }
            };

            socket.onerror = (error) => {
                console.error('接続エラー:', error);
            };

            socket.onclose = () => {
                console.log('切断されました。再接続します...');
                setTimeout(connectTwitch, 5000);
            };
        }

        connectTwitch();
    </script>
</body>
</html>