<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <style>
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; background: transparent; }
        body { 
            display: flex; flex-direction: column; justify-content: flex-end; 
            padding: 20px 20px 40px 20px; box-sizing: border-box;
            color: white; font-family: sans-serif; 
            text-shadow: 2px 2px 2px #000; 
        }
        #chat-container { display: flex; flex-direction: column; gap: 12px; width: 100%; }
        .message { line-height: 1.4; word-break: break-all; overflow-wrap: anywhere; animation: slideIn 0.2s ease-out forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .user-name { font-weight: bold; margin-right: 8px; white-space: nowrap; }
        .content { display: inline; }
        .emote { vertical-align: middle; margin: -2px 2px 0; width: 1.1em; }
    </style>
</head>
<body>
    <div id="chat-container"></div>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const CHANNEL_NAME = urlParams.get('channel') || 'nao075';
        const FONT_SIZE = urlParams.get('size') || '24';
        const HIDE_COMMANDS = urlParams.get('hidecmd') === 'true'; // コマンド非表示設定
        const IGNORE_USERS = (urlParams.get('ignore') || '').toLowerCase().split(','); // 除外リスト

        document.body.style.fontSize = FONT_SIZE + 'px';

        function connectTwitch() {
            const socket = new WebSocket('wss://irc-ws.chat.twitch.tv:443');
            socket.onopen = () => {
                socket.send('CAP REQ :twitch.tv/tags twitch.tv/commands');
                socket.send('PASS oauth:xdanyway');
                socket.send('NICK justinfan123');
                socket.send(`JOIN #${CHANNEL_NAME.toLowerCase()}`);
            };
            socket.onmessage = (event) => {
                const data = event.data;
                if (data.includes('PRIVMSG')) {
                    const tagPart = data.split(' :')[0];
                    const username = data.match(/:([^!]+)!/)?.[1] || "";
                    const color = tagPart.match(/color=([^;]+)/)?.[1] || "#ffb86c";
                    const displayName = tagPart.match(/display-name=([^;]+)/)?.[1] || username;
                    const emotesTag = tagPart.match(/emotes=([^;]+)/)?.[1] || "";
                    let message = data.split(`PRIVMSG #${CHANNEL_NAME.toLowerCase()} :`)[1].trim();

                    // --- 非表示フィルタリング ---
                    // 1. 除外ユーザーチェック
                    if (IGNORE_USERS.includes(username.toLowerCase())) return;
                    // 2. コマンド（!）チェック
                    if (HIDE_COMMANDS && message.startsWith('!')) return;

                    if (emotesTag) message = parseEmotes(message, emotesTag);
                    const container = document.getElementById('chat-container');
                    const div = document.createElement('div');
                    div.className = 'message';
                    div.innerHTML = `<span class="user-name" style="color: ${color}">${displayName}:</span><span class="content">${message}</span>`;
                    container.appendChild(div);
                    if (container.childNodes.length > 30) container.removeChild(container.firstChild);
                }
                if (data.startsWith('PING')) socket.send('PONG :tmi.twitch.tv');
            };

            function parseEmotes(text, emotes) {
                let emoteList = [];
                emotes.split('/').forEach(item => {
                    const [id, ranges] = item.split(':');
                    ranges.split(',').forEach(range => {
                        const [start, end] = range.split('-').map(Number);
                        emoteList.push({ id, start, end });
                    });
                });
                emoteList.sort((a, b) => b.start - a.start);
                let html = text;
                emoteList.forEach(emote => {
                    const url = `https://static-cdn.jtvnw.net/emoticons/v2/${emote.id}/default/dark/1.0`;
                    const imgTag = `<img class="emote" src="${url}">`;
                    html = html.substring(0, emote.start) + imgTag + html.substring(emote.end + 1);
                });
                return html;
            }
            socket.onclose = () => setTimeout(connectTwitch, 5000);
        }
        connectTwitch();
    </script>
</body>
</html>